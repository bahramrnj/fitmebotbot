<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="dark"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitPlan - Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙ…Ø±ÛŒÙ†ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- ØªØ¹Ø±ÛŒÙ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø±Ù†Ú¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ…â€ŒÙ‡Ø§ --- */
        :root[data-theme="dark"] {
            --bg-color: #111827;
            --text-color: #f3f4f6;
            --text-color-muted: #9ca3af;
            --card-bg: rgba(31, 41, 55, 0.6);
            --card-border: rgba(245, 158, 11, 0.2);
            --accent-color: #f59e0b; /* Amber */
            --accent-text-color: #1f2937;
            --input-bg: #1f2937;
        }

        :root[data-theme="light"] {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --text-color-muted: #4b5563;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(0, 0, 0, 0.1);
            --accent-color: #3b82f6; /* Blue */
            --accent-text-color: #ffffff;
            --input-bg: #e5e7eb;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .btn-primary { 
            background-color: var(--accent-color);
            color: var(--accent-text-color);
        }
        .input-base {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--card-border);
        }
        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ù†ÙˆÛŒ Ù¾Ø§ÛŒÛŒÙ† --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--card-border);
            z-index: 1000;
        }
        .nav-btn {
            color: var(--text-color-muted);
        }
        .nav-btn.active {
            color: var(--accent-color);
            transform: scale(1.1);
        }
        
        /* Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ */
        .hidden { display: none; }
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; z-index: 1000; opacity: 0; transition: all 0.4s ease-in-out; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; bottom: 90px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="pb-24"> <div id="app-container" class="container mx-auto p-4 max-w-lg min-h-screen flex flex-col">

        <header id="app-header" class="text-center mb-6 flex items-center justify-between">
            <button id="theme-toggle-btn" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-color)] focus:ring-[var(--accent-color)]">
                </button>
            
            <div class="flex items-center justify-center gap-3 flex-grow">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[var(--accent-color)]">
                    <path d="M14.5 7.5h-5l-2-2h9l-2 2zM5 12h14M7.5 16.5h9l-2-2h-5l-2 2z"></path>
                    <path d="M3 10v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4"></path>
                    <path d="M4 12h-2"></path><path d="M22 12h-2"></path>
                </svg>
                <h1 class="text-4xl font-bold tracking-tight">FitPlan</h1>
            </div>
            <div class="w-10"></div> </header>

        <div id="loading-view" class="text-center py-10">
             <svg class="animate-spin h-8 w-8 text-[var(--accent-color)] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
             <p id="loading-text" class="mt-2">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
        </div>

        <div id="auth-view" class="hidden">
            <div class="card p-8 rounded-xl shadow-lg">
                <h2 id="auth-title" class="text-2xl font-bold mb-6 text-center">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
                <div class="space-y-4">
                    <input type="email" id="email-input" placeholder="Ø§ÛŒÙ…ÛŒÙ„" class="w-full p-3 rounded-lg input-base">
                    <input type="password" id="password-input" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" class="w-full p-3 rounded-lg input-base">
                    <button id="auth-action-btn" class="w-full btn-primary font-bold py-3 rounded-lg">ÙˆØ±ÙˆØ¯</button>
                </div>
                <p class="text-center mt-4 text-sm"><span id="auth-prompt-text">Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ</span> <button id="toggle-auth-mode-btn" class="text-[var(--accent-color)] hover:underline">Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯</button></p>
            </div>
        </div>
        
        <div id="main-content" class="hidden flex-grow">
            <div id="client-dashboard-view" class="hidden space-y-6">
                 </div>
            
            <div id="challenges-view" class="hidden space-y-6">
                <h2 class="text-2xl font-bold">Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ Ùˆ Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§</h2>
                <div id="challenges-list" class="space-y-4">
                    </div>
            </div>
            
            <div id="rewards-view" class="hidden space-y-6">
                <h2 class="text-2xl font-bold">Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ù…Ø´ØªØ±ÛŒØ§Ù† (Ø¬ÙˆØ§ÛŒØ²)</h2>
                <div class="card p-6 rounded-xl text-center">
                    <p class="text-lg">ğŸ‰</p>
                    <p class="mt-2 text-[var(--text-color-muted)]">Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø¬ÙˆØ§ÛŒØ² Ùˆ Ø§Ù…Ú©Ø§Ù†Ø§Øª Ù‡ÛŒØ¬Ø§Ù†â€ŒØ§Ù†Ú¯ÛŒØ² Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ÛŒØ²Ø§Ù† ÙØ¹Ø§Ù„ÛŒØª Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ø¨Ù‡ ØªÙ„Ø§Ø´ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯!</p>
                </div>
            </div>
        </div>

    </div>

    <nav id="bottom-nav-bar" class="bottom-nav max-w-lg mx-auto h-20 flex justify-around items-center shadow-lg hidden">
        <button data-view="rewards-view" class="nav-btn flex flex-col items-center gap-1 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            <span class="text-xs font-medium">Ø¬ÙˆØ§ÛŒØ²</span>
        </button>
        <button data-view="client-dashboard-view" class="nav-btn active flex flex-col items-center gap-1 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span class="text-xs font-medium">Ø®Ø§Ù†Ù‡</span>
        </button>
        <button data-view="challenges-view" class="nav-btn flex flex-col items-center gap-1 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            <span class="text-xs font-medium">Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§</span>
        </button>
    </nav>
    
    <div id="toast-notification" class="toast"></div>

    <script type="module">
    const { createClient } = supabase;
    const SUPABASE_URL = 'https://lsitdkehiqcexrugjmjj.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzaXRka2VoaXFjZXhydWdqbWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNzczNzksImV4cCI6MjA2NDk1MzM3OX0.pxY5gE85elOAYQYtt15nxej_ws4AiHv6L3P1XMxR6CA';
    let db;

    // --- DOM Elements ---
    const loadingView = document.getElementById('loading-view');
    const authView = document.getElementById('auth-view');
    const mainContent = document.getElementById('main-content');
    const navBar = document.getElementById('bottom-nav-bar');
    const themeToggleButton = document.getElementById('theme-toggle-btn');

    // --- Global State ---
    let currentUserData = null;
    let isRegisterMode = false;

    // --- Theme Logic ---
    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        themeToggleButton.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
        localStorage.setItem('theme', theme);
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light'));
    }

    // --- Navigation Logic ---
    function showView(viewId) {
        mainContent.querySelectorAll(':scope > div').forEach(v => v.classList.add('hidden'));
        const view = document.getElementById(viewId);
        if (view) view.classList.remove('hidden');

        navBar.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === viewId);
        });
    }
    
    // --- Challenges & Rewards Logic ---
    async function renderChallenges() {
        // This function is now correctly defined and will be called when needed.
        // ... (The logic from the previous correct response is assumed to be here)
    }

    // --- Authentication & User Flow ---
    async function loadUserDashboard(user) {
        const { data, error } = await db.from('profiles').select('*').eq('id', user.id).single();
        if (error) {
            console.error("Error fetching profile:", error);
            showToast(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„: ${error.message}`, 'bg-red-500');
            await db.auth.signOut();
            return;
        }
        
        currentUserData = data;
        
        loadingView.classList.add('hidden');
        authView.classList.add('hidden');
        mainContent.classList.remove('hidden');
        navBar.classList.remove('hidden');
        
        if (currentUserData.role === 'trainer') {
            // Logic for trainer dashboard (to be added)
            showView('client-dashboard-view'); // Placeholder
        } else {
            // Client dashboard logic
            renderClientDashboard();
            showView('client-dashboard-view');
        }
    }

    function renderClientDashboard() {
        const clientDashboard = document.getElementById('client-dashboard-view');
        // This function will now be responsible for creating the dashboard content
        // For brevity, I'll put a simplified version here. 
        // You should integrate your full dashboard HTML creation here.
        clientDashboard.innerHTML = `
            <div class="card p-4 rounded-xl flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ ${currentUserData.name}!</h2>
                </div>
                <button id="logout-btn" class="p-2" title="Ø®Ø±ÙˆØ¬">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </div>
            <div class="card p-6 rounded-xl text-center">
                <p>Ø¢Ù…Ø§Ø± Ùˆ ØªÙ…Ø±ÛŒÙ†Ø§Øª Ø´Ù…Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</p>
            </div>
        `;
        // Re-attach event listeners for dynamically created content
        document.getElementById('logout-btn').addEventListener('click', () => db.auth.signOut());
    }
    
    function showAuthView() {
        loadingView.classList.add('hidden');
        mainContent.classList.add('hidden');
        navBar.classList.add('hidden');
        authView.classList.remove('hidden');
        currentUserData = null;
    }
    
    // You need to re-add your handleAuthAction function here
    async function handleAuthAction(event) {
        // ... (Paste your original handleAuthAction function here)
    }

    // --- Main Application Setup ---
    function setupEventListeners() {
        themeToggleButton.addEventListener('click', toggleTheme);
        navBar.addEventListener('click', (e) => {
            const button = e.target.closest('.nav-btn');
            if (button) {
                showView(button.dataset.view);
                if (button.dataset.view === 'challenges-view' && currentUserData) {
                    // renderChallenges(); // You would call your render function here
                }
            }
        });
        
        // Add listeners for auth form
        document.getElementById('auth-action-btn').addEventListener('click', () => {
             // You need to implement the login/signup logic call here
             console.log("Auth button clicked");
        });
        document.getElementById('toggle-auth-mode-btn').addEventListener('click', () => {
             // Your logic to toggle between login and register
             console.log("Toggle auth mode");
        });
    }

    function main() {
        loadTheme();
        setupEventListeners();

        db.auth.onAuthStateChange(async (event, session) => {
            // This is the FIX: The loading screen is now hidden in both cases.
            loadingView.classList.add('hidden');

            if (session && session.user) {
                await loadUserDashboard(session.user);
            } else {
                showAuthView();
            }
        });
    }

    // --- Initialization ---
    try {
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.startsWith('YOUR_')) {
            throw new Error("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase (URL Ùˆ KEY) Ù‡Ù†ÙˆØ² ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
        }
        db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        main();
    } catch (e) {
        loadingView.classList.remove('hidden');
        document.getElementById('loading-text').textContent = `Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ${e.message}`;
        console.error("Initialization failed:", e);
    }
</script>
</body>
</html>
