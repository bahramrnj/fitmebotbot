<!DOCTYPE html>
<html lang="fa" dir="rtl" data-theme="dark"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitPlan - برنامه تمرینی حرفه‌ای</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- تعریف متغیرهای رنگی برای تم‌ها --- */
        :root[data-theme="dark"] {
            --bg-color: #111827;
            --text-color: #f3f4f6;
            --text-color-muted: #9ca3af;
            --card-bg: rgba(31, 41, 55, 0.6);
            --card-border: rgba(245, 158, 11, 0.2);
            --accent-color: #f59e0b; /* Amber */
            --accent-text-color: #1f2937;
            --input-bg: #1f2937;
        }

        :root[data-theme="light"] {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --text-color-muted: #4b5563;
            --card-bg: rgba(255, 255, 255, 0.8);
            --card-border: rgba(0, 0, 0, 0.1);
            --accent-color: #3b82f6; /* Blue */
            --accent-text-color: #ffffff;
            --input-bg: #e5e7eb;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--card-border);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .btn-primary { 
            background-color: var(--accent-color);
            color: var(--accent-text-color);
        }
        .input-base {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--card-border);
        }
        /* --- استایل‌های جدید برای منوی پایین --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--card-border);
            z-index: 1000;
        }
        .nav-btn {
            color: var(--text-color-muted);
        }
        .nav-btn.active {
            color: var(--accent-color);
            transform: scale(1.1);
        }
        
        /* کلاس‌های کمکی */
        .hidden { display: none; }
        .toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; z-index: 1000; opacity: 0; transition: all 0.4s ease-in-out; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; bottom: 90px; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="pb-24"> <div id="app-container" class="container mx-auto p-4 max-w-lg min-h-screen flex flex-col">

        <header id="app-header" class="text-center mb-6 flex items-center justify-between">
            <button id="theme-toggle-btn" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[var(--bg-color)] focus:ring-[var(--accent-color)]">
                </button>
            
            <div class="flex items-center justify-center gap-3 flex-grow">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[var(--accent-color)]">
                    <path d="M14.5 7.5h-5l-2-2h9l-2 2zM5 12h14M7.5 16.5h9l-2-2h-5l-2 2z"></path>
                    <path d="M3 10v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4"></path>
                    <path d="M4 12h-2"></path><path d="M22 12h-2"></path>
                </svg>
                <h1 class="text-4xl font-bold tracking-tight">FitPlan</h1>
            </div>
            <div class="w-10"></div> </header>

        <div id="loading-view" class="text-center py-10">
             <svg class="animate-spin h-8 w-8 text-[var(--accent-color)] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
             <p id="loading-text" class="mt-2">در حال بارگذاری...</p>
        </div>

        <div id="auth-view" class="hidden">
            <div class="card p-8 rounded-xl shadow-lg">
                <h2 id="auth-title" class="text-2xl font-bold mb-6 text-center">ورود به حساب کاربری</h2>
                <div class="space-y-4">
                    <input type="email" id="email-input" placeholder="ایمیل" class="w-full p-3 rounded-lg input-base">
                    <input type="password" id="password-input" placeholder="رمز عبور" class="w-full p-3 rounded-lg input-base">
                    <button id="auth-action-btn" class="w-full btn-primary font-bold py-3 rounded-lg">ورود</button>
                </div>
                <p class="text-center mt-4 text-sm"><span id="auth-prompt-text">حساب کاربری ندارید؟</span> <button id="toggle-auth-mode-btn" class="text-[var(--accent-color)] hover:underline">ثبت نام کنید</button></p>
            </div>
        </div>
        
        <div id="main-content" class="hidden flex-grow">
            <div id="client-dashboard-view" class="hidden space-y-6">
                 </div>
            
            <div id="challenges-view" class="hidden space-y-6">
                <h2 class="text-2xl font-bold">چالش‌ها و دستاوردها</h2>
                <div id="challenges-list" class="space-y-4">
                    </div>
            </div>
            
            <div id="rewards-view" class="hidden space-y-6">
                <h2 class="text-2xl font-bold">باشگاه مشتریان (جوایز)</h2>
                <div class="card p-6 rounded-xl text-center">
                    <p class="text-lg">🎉</p>
                    <p class="mt-2 text-[var(--text-color-muted)]">این بخش به زودی با جوایز و امکانات هیجان‌انگیز بر اساس میزان فعالیت شما فعال خواهد شد. به تلاش ادامه دهید!</p>
                </div>
            </div>
        </div>

    </div>

    <nav id="bottom-nav-bar" class="bottom-nav max-w-lg mx-auto h-20 flex justify-around items-center shadow-lg hidden">
        <button data-view="rewards-view" class="nav-btn flex flex-col items-center gap-1 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            <span class="text-xs font-medium">جوایز</span>
        </button>
        <button data-view="client-dashboard-view" class="nav-btn active flex flex-col items-center gap-1 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span class="text-xs font-medium">خانه</span>
        </button>
        <button data-view="challenges-view" class="nav-btn flex flex-col items-center gap-1 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            <span class="text-xs font-medium">چالش‌ها</span>
        </button>
    </nav>
    
    <div id="toast-notification" class="toast"></div>

    <script type="module">
        const { createClient } = supabase;
        const SUPABASE_URL = 'https://lsitdkehiqcexrugjmjj.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzaXRka2VoaXFjZXhydWdqbWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNzczNzksImV4cCI6MjA2NDk1MzM3OX0.pxY5gE85elOAYQYtt15nxej_ws4AiHv6L3P1XMxR6CA';
        let db;
        // ... (Supabase initialization code - same as before)

        // --- NEW THEME LOGIC ---
        const themeToggleButton = document.getElementById('theme-toggle-btn');
        const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
        const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            themeToggleButton.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (systemPrefersDark ? 'dark' : 'light'));
        }
        
        // --- NEW NAVIGATION LOGIC ---
        const mainContent = document.getElementById('main-content');
        const navBar = document.getElementById('bottom-nav-bar');
        const navButtons = navBar.querySelectorAll('.nav-btn');

        function showView(viewId) {
             // Hide all views within main-content
            mainContent.querySelectorAll(':scope > div').forEach(v => v.classList.add('hidden'));
            
            // Show the requested view
            const view = document.getElementById(viewId);
            if (view) view.classList.remove('hidden');

            // Update active state on nav buttons
            navButtons.forEach(btn => {
                if (btn.dataset.view === viewId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        navBar.addEventListener('click', (e) => {
            const button = e.target.closest('.nav-btn');
            if (button) {
                showView(button.dataset.view);
                // Special actions when changing view
                if(button.dataset.view === 'challenges-view'){
                    renderChallenges();
                }
            }
        });
        
        // --- NEW CHALLENGES LOGIC ---
        async function renderChallenges() {
            const listEl = document.getElementById('challenges-list');
            listEl.innerHTML = `<p class="text-[var(--text-color-muted)]">در حال بارگذاری چالش‌ها...</p>`;

            try {
                // Fetch all challenges and user's completed achievements in parallel
                const [challengesRes, achievementsRes] = await Promise.all([
                    db.from('challenges').select('*'),
                    db.from('user_achievements').select('challenge_id').eq('user_id', currentUserData.id)
                ]);

                if (challengesRes.error || achievementsRes.error) {
                    throw new Error(challengesRes.error?.message || achievementsRes.error?.message);
                }

                const allChallenges = challengesRes.data;
                const completedChallengeIds = new Set(achievementsRes.data.map(a => a.challenge_id));

                if (allChallenges.length === 0) {
                    listEl.innerHTML = `<p class="text-[var(--text-color-muted)] text-center">چالشی برای نمایش وجود ندارد.</p>`;
                    return;
                }

                listEl.innerHTML = allChallenges.map(challenge => {
                    const isCompleted = completedChallengeIds.has(challenge.id);
                    return `
                        <div class="card p-4 rounded-lg flex items-center gap-4 ${isCompleted ? 'opacity-50' : ''}">
                            <div class="p-3 rounded-full ${isCompleted ? 'bg-green-500' : 'bg-[var(--accent-color)]'} text-white">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg">${challenge.title}</h3>
                                <p class="text-sm text-[var(--text-color-muted)]">${challenge.description}</p>
                            </div>
                            ${isCompleted ? `<span class="text-green-400 font-bold">✓</span>` : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                listEl.innerHTML = `<p class="text-red-500 text-center">خطا در بارگذاری چالش‌ها: ${error.message}</p>`;
            }
        }
        
        // --- Existing Logic (Modified for new structure) ---
        let currentUserData = null; // Keep this global

        async function loadUserDashboard(user) {
            const { data, error } = await db.from('profiles').select('*').eq('id', user.id).single();
            if (error) { /* handle error */ return; }
            currentUserData = data;
            
            // Show main app content and nav bar, hide auth
            document.getElementById('auth-view').classList.add('hidden');
            mainContent.classList.remove('hidden');
            navBar.classList.remove('hidden');
            
            // Set the initial view to the dashboard
            showView('client-dashboard-view');
            // Populate dashboard
            document.getElementById('client-dashboard-view').innerHTML = `
                <div class="card p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold">خوش آمدید، ${currentUserData.name}!</h2>
                        <p class="text-sm text-[var(--text-color-muted)]">امروز یک روز عالی برای تمرین است.</p>
                    </div>
                    <button id="logout-btn" class="p-2 rounded-full hover:bg-[var(--input-bg)]" title="خروج">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    </button>
                </div>
                `;
            document.getElementById('logout-btn').addEventListener('click', () => db.auth.signOut());
        }

        // --- MAIN APP START ---
        function main() {
            loadTheme();
            themeToggleButton.addEventListener('click', toggleTheme);

            // Supabase auth listener
            db.auth.onAuthStateChange(async (event, session) => {
                if (session && session.user) {
                    await loadUserDashboard(session.user);
                } else {
                    document.getElementById('auth-view').classList.remove('hidden');
                    mainContent.classList.add('hidden');
                    navBar.classList.add('hidden');
                    currentUserData = null;
                }
            });
        }
        
        try {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.startsWith('YOUR_')) {
                throw new Error("اطلاعات اتصال به Supabase (URL و KEY) هنوز وارد نشده است.");
            }
            db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            main();
        } catch (e) {
            document.getElementById('loading-text').textContent = `خطا در اتصال: ${e.message}`;
        }
        
    </script>
</body>
</html>
