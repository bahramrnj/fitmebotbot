<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitPlan - برنامه تمرینی با Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #0d1117;
            color: #e6edf3;
            background-image: linear-gradient(to bottom right, rgba(13, 17, 23, 0.95), rgba(22, 27, 34, 0.98)), url('https://placehold.co/1920x1080/0d1117/30363d.png?text=Workout');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .hidden { display: none; }
        .toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: all 0.4s ease-in-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .toast.show { opacity: 1; bottom: 40px; }
        .card {
            background-color: rgba(22, 27, 34, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-primary { background: linear-gradient(to right, #1e6adf, #2b84ea); }
        .btn-secondary { background: linear-gradient(to right, #2ea043, #38c172); }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body class="text-slate-200">

    <div id="app-container" class="container mx-auto p-4 max-w-lg min-h-screen flex flex-col justify-center">

        <header id="app-header" class="text-center mb-6 flex items-center justify-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M12 5C9.24 5 7 7.24 7 10v2c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2v-2c0-2.76-2.24-5-5-5z"></path><path d="M19 14v-2c0-1.1-.9-2-2-2"></path><path d="M5 12v2c0 1.1.9 2 2 2h2"></path><path d="M12 14v7"></path><path d="M9 21h6"></path></svg>
              <h1 class="text-4xl font-bold text-white tracking-tight">FitPlan</h1>
        </header>

        <!-- Loading View -->
        <div id="loading-view" class="text-center text-white py-10">
            <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p id="loading-text" class="mt-2">در حال بارگذاری...</p>
        </div>

        <!-- Onboarding View (First Time User) -->
        <div id="onboarding-view" class="hidden">
             <div class="card p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-2 text-center text-white">به FitPlan خوش آمدید!</h2>
                <p class="text-center text-slate-400 mb-6 text-sm">برای شروع، لطفا اطلاعات زیر را کامل کنید.</p>
                <div class="space-y-4">
                    <input type="text" id="onboarding-name-input" placeholder="نام شما" class="w-full p-3 border border-slate-600 rounded-lg bg-slate-900 text-white focus:ring-2 focus:ring-blue-500">
                    <select id="onboarding-role-select" class="w-full p-3 border border-slate-600 rounded-lg bg-slate-900 text-white focus:ring-2 focus:ring-blue-500">
                        <option value="client">شاگرد هستم</option>
                        <option value="trainer">مربی هستم</option>
                    </select>
                    <input type="number" id="onboarding-height-input" placeholder="قد (سانتی‌متر)" class="w-full p-3 border border-slate-600 rounded-lg bg-slate-900 text-white">
                    <input type="number" id="onboarding-weight-input" placeholder="وزن (کیلوگرم)" class="w-full p-3 border border-slate-600 rounded-lg bg-slate-900 text-white">
                    <input type="number" id="onboarding-age-input" placeholder="سن" class="w-full p-3 border border-slate-600 rounded-lg bg-slate-900 text-white">
                    <button id="complete-onboarding-btn" class="w-full btn-primary text-white font-bold py-3 rounded-lg hover:opacity-90 transition-opacity">ذخیره و ورود</button>
                </div>
            </div>
        </div>
        
        <!-- Client Dashboard View -->
        <div id="client-dashboard-view" class="hidden space-y-6">
             <div class="card p-4 rounded-xl flex justify-between items-center">
                 <div>
                     <h2 id="client-welcome-name" class="text-xl font-bold text-white"></h2>
                     <p id="today-date-string" class="text-sm text-slate-400"></p>
                 </div>
                 <div>
                    <button id="profile-btn" class="text-slate-400 hover:text-white" title="ویرایش پروفایل"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></button>
                </div>
             </div>
             <div class="grid grid-cols-2 gap-4">
                 <div class="card p-4 rounded-xl text-center">
                     <p class="text-3xl font-bold text-amber-400" id="daily-streak-stat">0</p>
                     <p class="text-sm text-slate-400">🔥 زنجیره روزانه</p>
                 </div>
                  <div class="card p-4 rounded-xl text-center">
                     <p class="text-3xl font-bold text-cyan-400" id="sessions-left-stat">-</p>
                     <p class="text-sm text-slate-400">📅 جلسات باقی‌مانده</p>
                 </div>
             </div>
             <div class="card p-6 rounded-xl">
                  <h3 class="text-xl font-bold mb-4 text-white">تمرینات امروز</h3>
                  <div id="daily-workout-list" class="space-y-3"></div>
             </div>
        </div>
        
        <!-- Client Profile View -->
        <div id="client-profile-view" class="hidden space-y-6">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-white">پروفایل من</h2><button id="back-to-dashboard-btn" class="text-sm text-blue-400 hover:underline">بازگشت</button></div>
            <div class="card p-6 rounded-xl space-y-4">
                 <h3 class="font-bold text-lg text-white">اطلاعات شخصی</h3>
                 <div><label class="text-sm text-slate-400">نام</label><input type="text" id="profile-name-input" class="w-full mt-1 p-2 border border-slate-600 rounded-lg bg-slate-900 text-white"></div>
                 <div><label class="text-sm text-slate-400">قد (سانتی‌متر)</label><input type="number" id="height-input" placeholder="مثلا: 180" class="w-full mt-1 p-2 border border-slate-600 rounded-lg bg-slate-900 text-white"></div>
                 <div><label class="text-sm text-slate-400">وزن (کیلوگرم)</label><input type="number" id="weight-input" placeholder="مثلا: 75" class="w-full mt-1 p-2 border border-slate-600 rounded-lg bg-slate-900 text-white"></div>
                 <div><label class="text-sm text-slate-400">سن</label><input type="number" id="age-input" placeholder="مثلا: 25" class="w-full mt-1 p-2 border border-slate-600 rounded-lg bg-slate-900 text-white"></div>
                 <hr class="border-slate-700">
                 <h3 class="font-bold text-lg text-white">اتصال به مربی</h3>
                 <div><label class="text-sm text-slate-400">کد اتصال مربی</label><input type="text" id="client-trainer-code-input" placeholder="کدی که از مربی گرفته‌اید" class="w-full mt-1 p-2 border border-slate-600 rounded-lg bg-slate-900 text-white"></div>
                <button id="save-profile-btn" class="w-full btn-secondary text-white font-bold py-2 rounded-lg mt-2">ذخیره پروفایل</button>
                 <hr class="border-slate-700">
                 <button id="reset-app-btn" class="w-full bg-red-800 text-white font-bold py-2 rounded-lg mt-2 hover:bg-red-700">ریست کامل برنامه (خروج)</button>

            </div>
        </div>

        <!-- Trainer Dashboard View -->
        <div id="trainer-dashboard-view" class="hidden space-y-6">
            <div class="card p-4 rounded-xl flex justify-between items-center">
                <div>
                    <h2 id="trainer-welcome-name" class="text-xl font-bold text-white"></h2>
                    <p id="trainer-code-display" class="text-sm text-slate-400 cursor-pointer" title="برای کپی کردن کلیک کنید"></p>
                </div>
            </div>
             <div class="card p-6 rounded-xl">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">شاگردان من</h3>
                </div>
                 <div id="clients-list" class="space-y-3"></div>
            </div>
        </div>
        
        <!-- Plan Creation/Edit Modal -->
        <div id="plan-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4">
            <form id="plan-form" class="card rounded-xl p-6 w-full max-w-lg space-y-4 flex flex-col max-h-[90vh]">
                <h3 id="plan-modal-title" class="text-xl font-bold text-white border-b border-slate-700 pb-3 flex-shrink-0">ایجاد / ویرایش برنامه</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 flex-shrink-0">
                    <input type="number" id="plan-total-sessions" placeholder="تعداد کل جلسات" class="p-3 border border-slate-600 rounded-lg bg-slate-900 text-white">
                    <input type="date" id="plan-start-date" title="تاریخ شروع" class="p-3 border border-slate-600 rounded-lg bg-slate-900 text-white">
                    <input type="date" id="plan-end-date" title="تاریخ پایان" class="p-3 border border-slate-600 rounded-lg bg-slate-900 text-white">
                </div>
                <div id="plan-weekly-schedule" class="flex-grow overflow-y-auto space-y-4 p-2 border-t border-b border-slate-700"></div>
                <div class="flex gap-4 flex-shrink-0">
                    <button id="cancel-plan-btn" type="button" class="w-1/2 bg-slate-600 text-white font-bold py-2 rounded-lg hover:bg-slate-700">لغو</button>
                    <button id="save-plan-btn" type="submit" class="w-1/2 btn-primary text-white font-bold py-2 rounded-lg hover:opacity-90">ذخیره برنامه</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script type="module">
        const { createClient } = supabase;

        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!                  مهم: اطلاعات Supabase                          !!
        // !!    این اطلاعات را از بخش Project Settings -> API در کنسول        !!
        // !!             Supabase خود دریافت و جایگزین کنید.                 !!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const SUPABASE_URL = 'https://lsitdkehiqcexrugjmjj.supabase.co'; // <--- جایگزین شود
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzaXRka2VoaXFjZXhydWdqbWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkzNzczNzksImV4cCI6MjA2NDk1MzM3OX0.pxY5gE85elOAYQYtt15nxej_ws4AiHv6L3P1XMxR6CA'; // <--- جایگزین شود

        let db;
        try {
            if (SUPABASE_URL.startsWith('YOUR_')) {
                throw new Error("اطلاعات اتصال به Supabase (URL و KEY) هنوز وارد نشده است.");
            }
            db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch(e) {
            console.error("Supabase initialization failed:", e);
            const loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.textContent = `خطا در اتصال به سرویس: ${e.message}`;
                const spinner = loadingText.parentElement.querySelector('svg');
                if (spinner) spinner.style.display = 'none';
            }
        }
        
        // --- App State & Utils ---
        const WEEK_DAYS = ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه'];
        let currentUserData = null;
        let currentUserId = null;
        let currentEditingClient = null;

        function showView(viewId) {
            document.querySelectorAll('#app-container > div:not(header)').forEach(v => v.classList.add('hidden'));
            const view = document.getElementById(viewId);
            if (view) view.classList.remove('hidden');
        }
        function showToast(message, color = 'bg-slate-800') { const t = document.getElementById('toast-notification'); t.textContent = message; t.className = `toast show ${color}`; setTimeout(() => { t.className = 'toast'; }, 3500); }
        function getPersianDayName(date) { return new Intl.DateTimeFormat('fa-IR', { weekday: 'long' }).format(date); }
        function formatDate(dateString) { return dateString ? new Date(dateString).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' }) : '-'; }
        
        // --- User Identification (No Auth) ---
        function getOrCreateUserId() {
            let userId = localStorage.getItem('fitplan_uuid');
            if (!userId) {
                userId = crypto.randomUUID();
                localStorage.setItem('fitplan_uuid', userId);
            }
            return userId;
        }

        // --- App Initialization ---
        async function initializeApp() {
            if (!db) return; // Stop if Supabase client failed to initialize

            currentUserId = getOrCreateUserId();
            
            const { data, error } = await db.from('profiles').select('*').eq('id', currentUserId).single();

            if (error && error.code !== 'PGRST116') { // PGRST116 means no rows found
                console.error('Error fetching profile:', error);
                showToast(`خطا در بارگذاری اطلاعات پروفایل: ${error.message}`, 'bg-red-500');
                return;
            }

            if (data) {
                currentUserData = data;
                if (currentUserData.role === 'trainer') {
                    showTrainerDashboard();
                } else {
                    showClientDashboard();
                }
            } else {
                showView('onboarding-view');
            }
        }

        async function handleOnboarding() {
            const name = document.getElementById('onboarding-name-input').value.trim();
            const role = document.getElementById('onboarding-role-select').value;
            const height = document.getElementById('onboarding-height-input').value.trim();
            const weight = document.getElementById('onboarding-weight-input').value.trim();
            const age = document.getElementById('onboarding-age-input').value.trim();

            if (!name) return showToast('لطفا نام خود را وارد کنید.', 'bg-red-600');
            
            const newUser = {
                id: currentUserId,
                name, role,
                profile_data: { height, weight, age },
                streaks: { daily: 0, lastCompletedDate: null },
                trainer_code: role === 'trainer' ? `FIT-${Math.random().toString(36).substring(2, 8).toUpperCase()}` : null,
                linked_trainer_id: null
            };
            
            const { error } = await db.from('profiles').insert(newUser);

            if (error) {
                console.error('Onboarding error:', error);
                showToast(`خطا در ذخیره اطلاعات: ${error.message}`, 'bg-red-600');
            } else {
                currentUserData = newUser;
                initializeApp();
            }
        }

        // --- Trainer Logic ---
        async function showTrainerDashboard() {
            showView('trainer-dashboard-view');
            document.getElementById('trainer-welcome-name').textContent = `مربی ${currentUserData.name}`;
            const codeDisplay = document.getElementById('trainer-code-display');
            codeDisplay.textContent = `کد اتصال شما: ${currentUserData.trainer_code}`;
            codeDisplay.onclick = () => {
                navigator.clipboard.writeText(currentUserData.trainer_code);
                showToast('کد اتصال کپی شد!', 'bg-green-600');
            };
            await renderClientsList();
        }
        
        async function renderClientsList() {
             const clientListEl = document.getElementById('clients-list');
             clientListEl.innerHTML = `<p class="text-slate-500 text-center">در حال بارگذاری شاگردان...</p>`;

             const { data: clients, error } = await db.from('profiles').select('*').eq('linked_trainer_id', currentUserId);
            
             if(error) {
                console.error("Error fetching clients:", error);
                clientListEl.innerHTML = `<p class="text-red-500 text-center">خطا در دریافت لیست شاگردان.</p>`;
                return;
             }

             if (clients.length === 0) {
                clientListEl.innerHTML = `<p class="text-slate-500 text-center p-4">هنوز شاگردی به شما متصل نشده است. کد اتصال خود را در اختیار شاگردان قرار دهید تا از بخش پروفایل به شما متصل شوند.</p>`;
                return;
             }

            const clientIds = clients.map(c => c.id);
            const { data: plans, error: plansError } = await db.from('workout_plans').select('*').in('client_id', clientIds);

            if (plansError) {
                 console.error("Error fetching plans:", plansError);
                 clientListEl.innerHTML = `<p class="text-red-500 text-center">خطا در دریافت برنامه‌های شاگردان.</p>`;
                 return;
            }

            const plansMap = new Map(plans.map(p => [p.client_id, p]));

             clientListEl.innerHTML = '';
             for(const client of clients) {
                const plan = plansMap.get(client.id);

                const clientEl = document.createElement('div');
                clientEl.className = 'card p-3 space-y-2 cursor-pointer hover:bg-slate-700/50 transition-colors';
                clientEl.dataset.clientId = client.id;
                clientEl.innerHTML = `
                    <div class="flex justify-between items-center pointer-events-none">
                        <p class="font-bold text-white">${client.name}</p>
                        <span class="text-sm text-blue-400">${plan ? 'ویرایش برنامه' : 'ایجاد برنامه'}</span>
                    </div>
                     <div class="flex justify-between items-center text-xs text-slate-400 pointer-events-none">
                        <p>جلسات: <span class="font-mono">${plan?.plan_data?.attendedSessions || 0}/${plan?.plan_data?.totalSessions || '-'}</span></p>
                        <p>پایان دوره: <span class="font-mono">${formatDate(plan?.plan_data?.endDate)}</span></p>
                    </div>`;
                clientEl.addEventListener('click', () => openPlanModal(client));
                clientListEl.appendChild(clientEl);
             }
        }
        
        async function openPlanModal(client) {
            currentEditingClient = client;
            const modal = document.getElementById('plan-modal');
            document.getElementById('plan-form').reset();
            
            const { data: plan, error } = await db.from('workout_plans').select('*').eq('client_id', client.id).single();

            const scheduleContainer = document.getElementById('plan-weekly-schedule');
            scheduleContainer.innerHTML = WEEK_DAYS.map(day => `<div class="p-3 border border-slate-700 rounded-lg bg-slate-800/50 mb-4"><h4 class="text-md font-bold mb-2 text-white">${day}</h4><div class="space-y-2" data-day="${day}"></div><button type="button" class="add-exercise-btn mt-2 text-sm text-blue-400 hover:text-blue-300" data-day="${day}">+ افزودن تمرین</button></div>`).join('');

            if (plan && plan.plan_data) {
                const planData = plan.plan_data;
                document.getElementById('plan-total-sessions').value = planData.totalSessions || '';
                document.getElementById('plan-start-date').value = planData.startDate || '';
                document.getElementById('plan-end-date').value = planData.endDate || '';
                Object.keys(planData.schedule || {}).forEach(day => {
                    const dayContainer = scheduleContainer.querySelector(`div[data-day="${day}"]`);
                    if(dayContainer) planData.schedule[day].forEach(ex => addExerciseInput(dayContainer, ex));
                });
            }
            modal.classList.remove('hidden');
        }

        function addExerciseInput(container, exercise = { name: '', sets: '', reps: '' }) {
            const exerciseNode = document.createElement('div');
            exerciseNode.className = 'exercise-item flex gap-2 items-center';
            exerciseNode.innerHTML = `<input type="text" value="${exercise.name}" placeholder="نام تمرین" class="w-1/2 p-2 border border-slate-600 rounded bg-slate-900 text-white focus:ring-1 focus:ring-blue-500"><input type="text" value="${exercise.sets}" placeholder="ست" class="w-1/4 p-2 border border-slate-600 rounded bg-slate-900 text-white text-center focus:ring-1 focus:ring-blue-500"><input type="text" value="${exercise.reps}" placeholder="تکرار" class="w-1/4 p-2 border border-slate-600 rounded bg-slate-900 text-white text-center focus:ring-1 focus:ring-blue-500"><button type="button" class="remove-exercise-btn text-red-500 hover:text-red-400 p-1">✖</button>`;
            container.appendChild(exerciseNode);
        }
        
        async function savePlan(event) {
            event.preventDefault();
            const clientId = currentEditingClient.id;
            const { data: existingPlan } = await db.from('workout_plans').select('plan_data').eq('client_id', clientId).single();

            const schedule = {};
            WEEK_DAYS.forEach(day => {
                schedule[day] = Array.from(document.querySelectorAll(`#plan-weekly-schedule div[data-day="${day}"] .exercise-item`)).map(item => ({
                    name: item.querySelector('input[placeholder="نام تمرین"]').value.trim(),
                    sets: item.querySelector('input[placeholder="ست"]').value.trim(),
                    reps: item.querySelector('input[placeholder="تکرار"]').value.trim(),
                    done: false
                })).filter(ex => ex.name);
            });

            const planData = {
                totalSessions: parseInt(document.getElementById('plan-total-sessions').value) || 0,
                startDate: document.getElementById('plan-start-date').value,
                endDate: document.getElementById('plan-end-date').value,
                attendedSessions: existingPlan?.plan_data?.attendedSessions || 0,
                attendedDates: existingPlan?.plan_data?.attendedDates || [],
                schedule
            };

            const { error } = await db.from('workout_plans').upsert({ client_id: clientId, trainer_id: currentUserId, plan_data: planData }, { onConflict: 'client_id' });
            
            if (error) {
                console.error("Save plan error:", error);
                showToast(`خطا در ذخیره برنامه: ${error.message}`, 'bg-red-600');
            } else {
                 showToast('برنامه با موفقیت ذخیره شد!', 'bg-green-600');
                 document.getElementById('plan-modal').classList.add('hidden');
                 await renderClientsList();
            }
        }


        // --- Client Logic ---
        async function showClientDashboard() {
            showView('client-dashboard-view');
            document.getElementById('client-welcome-name').textContent = `${currentUserData.name}، خوش آمدید!`;
            document.getElementById('today-date-string').textContent = `امروز ${getPersianDayName(new Date())}`;
            
            await loadClientPlan();
            
            checkAndResetStreak();
            renderStreakInfo();
            renderDailyWorkout();
            
            const planData = currentUserData.plan?.plan_data;
            const sessionsLeft = (planData?.totalSessions || 0) - (planData?.attendedSessions || 0);
            document.getElementById('sessions-left-stat').textContent = currentUserData.plan ? (sessionsLeft >= 0 ? sessionsLeft : 0) : '-';
        }

        async function loadClientPlan() {
            if (!currentUserData.linked_trainer_id) {
                currentUserData.plan = null;
                return;
            }
            const { data, error } = await db.from('workout_plans').select('*').eq('client_id', currentUserId).single();
            if (error && error.code !== 'PGRST116') {
                 console.error("Error fetching plan:", error);
            }
            currentUserData.plan = data;
        }

        function renderDailyWorkout() {
            const workoutList = document.getElementById('daily-workout-list');
            const planData = currentUserData.plan?.plan_data;

            if (!planData || !planData.schedule) {
                workoutList.innerHTML = `<p class="text-slate-400 text-center p-4">هنوز برنامه‌ای برای شما ثبت نشده است. در بخش پروفایل، با استفاده از کد مربی به او متصل شوید.</p>`;
                return;
            }
            
            const today = getPersianDayName(new Date());
            const todaysWorkout = planData.schedule[today] || [];
            
            if (todaysWorkout.length === 0) {
                workoutList.innerHTML = `<div class="text-center p-4 rounded-lg bg-green-500/10 text-green-400">امروز روز استراحت است!</div>`;
                return;
            }
            
            workoutList.innerHTML = todaysWorkout.map((ex, i) => `
            <div class="card p-3 flex items-center justify-between transition ${ex.done ? 'opacity-50' : ''}">
                <div><p class="font-semibold text-white">${ex.name}</p><p class="text-sm text-slate-400">${ex.sets} ست × ${ex.reps} تکرار</p></div>
                <input type="checkbox" data-day="${today}" data-index="${i}" class="exercise-checkbox w-6 h-6 text-green-500 bg-slate-700 border-slate-600 rounded" ${ex.done ? 'checked' : ''}>
            </div>`).join('');
        }

        function renderStreakInfo() {
            document.getElementById('daily-streak-stat').textContent = currentUserData.streaks.daily;
        }

        async function updateSessionAndStreak() {
             const todayStr = new Date().toISOString().split('T')[0];
             const planData = currentUserData.plan.plan_data;

             if (planData.attendedDates?.includes(todayStr)) return;
             
             planData.attendedDates = [...(planData.attendedDates || []), todayStr];
             planData.attendedSessions = (planData.attendedSessions || 0) + 1;
             
             const lastCompletedDate = currentUserData.streaks?.lastCompletedDate || null;
             let newStreakCount = 1;
             if(lastCompletedDate) {
                 const today = new Date();
                 const yesterday = new Date(today);
                 yesterday.setDate(today.getDate() - 1);
                 if (lastCompletedDate === yesterday.toISOString().split('T')[0]) {
                     newStreakCount = (currentUserData.streaks.daily || 0) + 1;
                 }
             }
             
             currentUserData.streaks = { daily: newStreakCount, lastCompletedDate: todayStr };
             
             // Update both user and plan in the database
             const { error: userError } = await db.from('profiles').update({ streaks: currentUserData.streaks }).eq('id', currentUserId);
             const { error: planError } = await db.from('workout_plans').update({ plan_data: planData }).eq('client_id', currentUserId);
             
             if(userError || planError) console.error("Update error:", userError, planError);

             renderStreakInfo();
             showToast(`💪 دمت گرم! تمرین امروز کامل شد. زنجیره شما به ${newStreakCount} روز رسید!`, 'bg-green-600');
             showClientDashboard();
        }
        
        async function checkAndResetStreak() {
            const streaks = currentUserData.streaks;
            if (!streaks || !streaks.lastCompletedDate) return;
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (streaks.lastCompletedDate !== todayStr && streaks.lastCompletedDate !== yesterdayStr) {
                currentUserData.streaks.daily = 0;
                await db.from('profiles').update({ streaks: currentUserData.streaks }).eq('id', currentUserId);
            }
        }

        async function toggleExerciseStatus(e) {
            const { day, index } = e.target.dataset;
            const isDone = e.target.checked;
            
            currentUserData.plan.plan_data.schedule[day][parseInt(index)].done = isDone;

            const { error } = await db.from('workout_plans').update({ plan_data: currentUserData.plan.plan_data }).eq('client_id', currentUserId);
            if (error) console.error("Error updating plan status:", error);
            
            if (currentUserData.plan.plan_data.schedule[day].every(ex => ex.done)) {
                await updateSessionAndStreak();
            } else {
                 showClientDashboard();
            }
        }
        
        function showClientProfile() {
            showView('client-profile-view');
            document.getElementById('profile-name-input').value = currentUserData.name || '';
            document.getElementById('height-input').value = currentUserData.profile_data.height || '';
            document.getElementById('weight-input').value = currentUserData.profile_data.weight || '';
            document.getElementById('age-input').value = currentUserData.profile_data.age || '';
        }
        
        async function saveProfile() {
            const updatedProfile = {
                name: document.getElementById('profile-name-input').value.trim(),
                profile_data: {
                    height: document.getElementById('height-input').value.trim(),
                    weight: document.getElementById('weight-input').value.trim(),
                    age: document.getElementById('age-input').value.trim()
                }
            };

            const trainerCode = document.getElementById('client-trainer-code-input').value.trim();
            if (trainerCode) {
                 const { data: trainer, error } = await db.from('profiles').select('id').eq('trainer_code', trainerCode).single();
                 if(error || !trainer) {
                    return showToast('کد مربی یافت نشد.', 'bg-red-600');
                 }
                 updatedProfile.linked_trainer_id = trainer.id;
            } else {
                 updatedProfile.linked_trainer_id = null;
            }
            
            const { error } = await db.from('profiles').update(updatedProfile).eq('id', currentUserId);
            if (error) {
                console.error("Save profile error:", error);
                showToast('خطا در ذخیره پروفایل.', 'bg-red-600');
            } else {
                 showToast('پروفایل با موفقیت ذخیره شد.', 'bg-green-600');
                 // Refresh local data
                 currentUserData = {...currentUserData, ...updatedProfile};
                 showClientDashboard();
            }
        }
        
        // --- Event Listeners Setup ---
        function setupEventListeners() {
            document.getElementById('complete-onboarding-btn').addEventListener('click', handleOnboarding);
            document.getElementById('profile-btn').addEventListener('click', showClientProfile);
            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => initializeApp());
            document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
            document.getElementById('add-client-btn').remove(); // This button is removed as the flow is client-initiated now.

            document.getElementById('plan-form').addEventListener('submit', savePlan);
            document.getElementById('cancel-plan-btn').addEventListener('click', () => document.getElementById('plan-modal').classList.add('hidden'));
            document.getElementById('reset-app-btn').addEventListener('click', () => {
                if(confirm("آیا مطمئن هستید؟ تمام اطلاعات شما از این مرورگر پاک شده و برنامه از نو شروع می‌شود.")){
                    localStorage.removeItem('fitplan_uuid');
                    location.reload();
                }
            });
            
            document.addEventListener('click', e => {
                if (e.target.matches('.add-exercise-btn')) addExerciseInput(e.target.previousElementSibling);
                if (e.target.matches('.remove-exercise-btn')) e.target.closest('.exercise-item').remove();
            });

            document.addEventListener('change', e => {
                 if (e.target.matches('.exercise-checkbox')) toggleExerciseStatus(e);
            });
        }

        // --- App Initialization ---
        function main() {
            showView('loading-view');
            setupEventListeners();
            if (db) { 
                initializeApp();
            }
        }

        main();

    </script>
</body>
</ht
